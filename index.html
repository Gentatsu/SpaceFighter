<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>game</title>

<script src="libs/easeljs-0.7.0.min.js"></script>
<script src="libs/tweenjs-0.5.0.min.js"></script>
<script src="libs/movieclip-0.7.0.min.js"></script>
<script src="libs/preloadjs-0.4.0.min.js"></script>
<script src="game.js"></script>

<script>
var canvas, stage, exportRoot;
var score, inPlay, scoreMod, meteors = [], speed, bullets = [], turning=0, randTurn = Math.floor((Math.random() * 10000) + 1), direction =1;
var shield, time, power, powerMove, powerUp;
var hero;
const screenX = 1024;
//Background image from - http://webtreats.mysitemyway.com/tileable-classic-nebula-space-patterns/
function init() {
	canvas = document.getElementById("canvas");
	images = images||{};

	var loader = new createjs.LoadQueue(false);
	loader.addEventListener("fileload", handleFileLoad);
	loader.addEventListener("complete", handleComplete);
	loader.loadManifest(lib.properties.manifest);
}

function handleFileLoad(evt) {
	if (evt.item.type == "image") { images[evt.item.id] = evt.result; }
}

function handleComplete() {
	exportRoot = new lib.game();

	stage = new createjs.Stage(canvas);
	stage.addChild(exportRoot);
	stage.update();
  hero = exportRoot.hero;
  hero.rad = 38;
	createjs.Ticker.setFPS(lib.properties.fps);
	createjs.Ticker.addEventListener("tick", tick);
	endX = hero.x; 
  endY = hero.y; 
  stage.addEventListener("stagemousemove", moveHero);
  canvas.addEventListener("click", mouseDown);
  //exportRoot.playButton.addEventListener("click", playClicked);
  exportRoot.gameOver.visible = false; 
  exportRoot.bullet.visible = false;
  exportRoot.meteor1.visible = false;
  exportRoot.meteor2.visible = false;
  exportRoot.meteor3.visible = false;
  resetGame();
  inPlay = true;
}

function moveHero(evt)
{
  endX = evt.stageX;
  endY = evt.stageY;
}

function tick(event)
{ 
  if (inPlay)
  {
    hero.x -= (hero.x - endX)/6; 
    hero.y -= (hero.y - endY)/6; 
    score ++;
    exportRoot.score.text = Math.floor  (score / 10); 
    addMeteors();
    moveMeteors();
    moveBullets();
    powerUps();
    checkBulletsMeteors();
    //inPlay = false;
    if (randTurn < 0 && turning <= 0)
    {
      turning = 45;
      randTurn = Math.floor((Math.random() * 10000) + 1);
      direction *= -1;
    }
    if (turning > 0)
    {
      hero.rotation -= 4;
      turning --;
    }
    randTurn --;
  }
  else
  {
    exportRoot.gameOver.visible = true;
    
  }
  //speed = Math.round(score/2);
  stage.update(event); 
}

function playClicked(e)
{
  resetGame();
}

function mouseDown(e) {
  var bullet = new lib.bullet;
  bullet.vel = 10; 
  if (direction == 1)
  {
    bullet.x =  hero.x +60;
    bullet.y = hero.y +3;
  }
  else
  {
    bullet.x =  hero.x -60;
    bullet.y = hero.y -3;
  }
  bullet.rad = 5;
  bullets.push(bullet);
  exportRoot.addChild(bullet); 
  stage.update(e);
}
  

function resetGame()
{
  exportRoot.gameOver.visible = false; 
  score = 0;
  scoreMod = 0;
  meteors = [];
  speed = 1;
  shield = false; 
  time = false; 
  powerMove = false; 
  powerUp = null; 
  power = exportRoot.power; 
  reset(power); 
}

function addMeteors()
{ 
  if (meteors.length < 10 || Math.random() < 0.01 && meteors.length < 25) 
  { 
    var meteor; 
    var type = Math.round(Math.random()*2)+1; 
    if (type == 1)
    { 
      meteor = new lib.meteor1(); 
      meteor.setTransform(40,40); 
      meteor.vel = Math.round(Math.random()*2)+(1+speed); 
      meteor.rad = 35; 
    } 
    if (type == 2)
    { 
      meteor = new lib.meteor2(); 
      meteor.setTransform(47,47); 
      meteor.vel = Math.round(Math.random()*4)+(3+speed); 
      meteor.rad = 40; 
    } 
    if (type == 3)
    { 
      meteor = new lib.meteor3(); 
      meteor.setTransform(9,9); 
      meteor.vel = Math.round(Math.random()*6)+(6+speed); 
      meteor.rad = 3; 
    } 
    reset(meteor); 
    meteors.push(meteor); 
    exportRoot.addChild(meteor); 
  } 
} 

function reset(met)
{ 
  met.y = Math.random()*(660+met.nominalBounds.height); 
  if(direction == 1)
  {
    met.x = (Math.random()*300)+960; 
  }
  else
  {
    met.x = (Math.random()*300)-960; 
  }
} 

function moveMeteors()
{ 
  for (var i=meteors.length-1; i>=0; i--) 
  { 
    meteor = meteors[i]; 
    if (time)
    {
      meteor.x -= (meteor.vel * direction)/2; 
      meteor.rotation += meteor.vel/4; 
    }
    else
    {
      meteor.x -= meteor.vel * direction; 
      meteor.rotation += meteor.vel/2; 
    }
    if (direction == 1)
    {
      if (meteor.x < -100)
      { 
        remove(meteor,meteors);
      }
    } 
    else
    {
      if (meteor.x > 1100)
      { 
        remove(meteor,meteors);
      }
    }
  } 
  if (checkCollide(hero,meteor) && !shield  )
  {
    
  }
} 

function moveBullets()
{ 
  for (var i=bullets.length-1; i>=0; i--) 
  { 
    bullet = bullets[i]; 
    bullet.x += meteor.vel * direction; 
    if (bullet.x > 1100)
    {
      remove(bullet, bullets);
    }
  } 
}

function checkCollide(a, b)
{
  dx = b.x - a.x;
  dy = b.y - a.y;
  radii = a.rad + b.rad;
  return ( ( dx * dx )  + ( dy * dy ) < radii * radii ) 
}

function checkBulletsMeteors()
{
  var bulletsToRemove = [];
  var meteorsToRemove = [];
  for (var i=bullets.length-1; i >= 0; i--)
  {
    bullet = bullets[i];
    for (var j=meteors.length-1; j >= 0; j--)
    {
      meteor = meteors[j];
      if (checkCollide(bullet,meteor))
      {
        remove(bullet,bullets);
        remove(meteor, meteors);
      }
    }
  }
}

function remove(item, items)
{
   var index = items.indexOf(item);
   items.splice(index, 1);
   exportRoot.removeChild(item);
}

function powerUps()
{ 
  if(Math.random() < 0.1 && powerMove==false && time == false && shield == false )
  { 
    powerMove=true; 
    powerUp = Math.round(Math.random()*2); 
    power.gotoAndStop(powerUp); 
    power.rad = 15;
  } 
  if(powerMove)
  { 
    power.x -= 10 * direction; 
    power.rotation += 5; 
    if (power.x < -100)
    { 
      reset(power); 
      powerMove = false; 
    } 
    if (checkCollide(hero, power))
    {
      powerMove = false;
      switch (powerUp)
      {
        case 0:
          score += 20;
          break;
        case 1:
          setTimeout(slowTime,15000); 
          time = true;
          break;
        case 2:        
          setTimeout(shieldTime,15000); 
          shield = true; 
          exportRoot.hero.gotoAndPlay("shield"); 
          break;
      }
      reset(power);
    }
  } 
} 

function slowTime()
{ 
  time=false; 
} 
function shieldTime()
{ 
  shield=false; 
  exportRoot.hero.gotoAndPlay("fly"); 
} 



</script>
</head>
<body onload="init();" style="background-color:#D4D4D4">
	<canvas id="canvas" width="960" height="720" style="background-color:#000000"></canvas>
</body>
</html>
